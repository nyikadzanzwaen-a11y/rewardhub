{% extends 'tenants/analytics/base.html' %}
{% load humanize %}

{% block title %}Customer Analytics - {{ tenant.business_name }}{% endblock %}

{% block analytics_content %}
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Customer Analytics</h2>
        <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-600">Date Range:</span>
            <div class="flex space-x-2">
                <a href="?date_range=7d" class="px-3 py-1 text-sm rounded-full {% if selected_date_range == '7d' %}bg-blue-100 text-blue-700 font-medium{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">Last 7 days</a>
                <a href="?date_range=30d" class="px-3 py-1 text-sm rounded-full {% if selected_date_range == '30d' %}bg-blue-100 text-blue-700 font-medium{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">Last 30 days</a>
                <a href="?date_range=90d" class="px-3 py-1 text-sm rounded-full {% if selected_date_range == '90d' or not selected_date_range %}bg-blue-100 text-blue-700 font-medium{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">Last 90 days</a>
            </div>
        </div>
    </div>

    <!-- Customer Segmentation Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        {% for segment in segment_data %}
        <div class="bg-white border rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium text-gray-700">{{ segment.name }}</h3>
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">{{ segment.percentage }}%</span>
            </div>
            <p class="text-3xl font-bold text-gray-900">{{ segment.count|intcomma }}</p>
            <div class="mt-4 w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full" style="width: {{ segment.percentage }}%"></div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Customer Growth Chart -->
        <div class="bg-white p-6 rounded-lg border shadow-sm">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Customer Growth</h3>
            <div class="h-64">
                <canvas id="customerGrowthChart"></canvas>
            </div>
        </div>

        <!-- Activity by Day of Week -->
        <div class="bg-white p-6 rounded-lg border shadow-sm">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Activity by Day of Week</h3>
            <div class="h-64">
                <canvas id="weekdayActivityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Customers -->
    <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Top Customers by Points</h3>
            <span class="text-sm text-gray-500">Showing top 10</span>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member Since</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Activity</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for customer in top_customers %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                    <span class="text-blue-600 font-medium">{{ customer.customer.first_name|first|upper }}{{ customer.customer.last_name|first|upper }}</span>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ customer.customer.get_full_name }}</div>
                                    <div class="text-sm text-gray-500">{{ customer.tier.name|default:"No Tier" }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ customer.customer.email }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ customer.created_at|date:"M d, Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                {{ customer.total_points|intcomma }} pts
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ customer.last_activity|timesince }} ago</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Customer Growth Chart
const growthCtx = document.getElementById('customerGrowthChart').getContext('2d');
const growthData = JSON.parse('{{ growth_data|escapejs }}');

new Chart(growthCtx, {
    type: 'line',
    data: {
        labels: growthData.map(item => item.date),
        datasets: [{
            label: 'Total Customers',
            data: growthData.map(item => item.count),
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.3,
            fill: true,
            pointBackgroundColor: 'white',
            pointBorderColor: 'rgb(59, 130, 246)',
            pointHoverRadius: 5,
            pointHoverBackgroundColor: 'rgb(59, 130, 246)',
            pointHoverBorderColor: 'white',
            pointHoverBorderWidth: 2,
            pointRadius: 3,
            pointHitRadius: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'white',
                titleColor: '#1F2937',
                bodyColor: '#4B5563',
                borderColor: '#E5E7EB',
                borderWidth: 1,
                padding: 12,
                boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                callbacks: {
                    label: function(context) {
                        return `Customers: ${context.raw.toLocaleString()}`;
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#6B7280',
                    maxRotation: 45,
                    minRotation: 45
                }
            },
            y: {
                beginAtZero: true,
                grid: {
                    color: '#F3F4F6'
                },
                ticks: {
                    color: '#6B7280',
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

// Weekday Activity Chart
const weekdayCtx = document.getElementById('weekdayActivityChart').getContext('2d');
const weekdayLabels = JSON.parse('{{ weekday_labels|escapejs }}');
const weekdayData = JSON.parse('{{ weekday_activity|escapejs }}');

new Chart(weekdayCtx, {
    type: 'bar',
    data: {
        labels: weekdayLabels,
        datasets: [{
            label: 'Transactions',
            data: weekdayData,
            backgroundColor: [
                'rgba(59, 130, 246, 0.7)',
                'rgba(99, 102, 241, 0.7)',
                'rgba(139, 92, 246, 0.7)',
                'rgba(168, 85, 247, 0.7)',
                'rgba(217, 70, 239, 0.7)',
                'rgba(236, 72, 153, 0.7)',
                'rgba(244, 63, 94, 0.7)'
            ],
            borderColor: [
                'rgb(59, 130, 246)',
                'rgb(99, 102, 241)',
                'rgb(139, 92, 246)',
                'rgb(168, 85, 247)',
                'rgb(217, 70, 239)',
                'rgb(236, 72, 153)',
                'rgb(244, 63, 94)'
            ],
            borderWidth: 1,
            borderRadius: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'white',
                titleColor: '#1F2937',
                bodyColor: '#4B5563',
                borderColor: '#E5E7EB',
                borderWidth: 1,
                padding: 12,
                boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
            }
        },
        scales: {
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#6B7280'
                }
            },
            y: {
                beginAtZero: true,
                grid: {
                    color: '#F3F4F6'
                },
                ticks: {
                    color: '#6B7280',
                    precision: 0
                }
            }
        }
    }
});
</script>
{% endblock %}
