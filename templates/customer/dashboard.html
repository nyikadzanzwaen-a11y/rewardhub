{% extends 'base.html' %}

{% block title %}Dashboard - LoyaltyAI{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Points Balance Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Points Balance</p>
                <p class="text-2xl font-bold text-gray-900" id="points-balance">{{ points_balance }}</p>
            </div>
        </div>
    </div>

    <!-- Current Tier Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                </svg>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Current Tier</p>
                <p class="text-2xl font-bold text-gray-900">{{ current_tier|default:"Bronze" }}</p>
            </div>
        </div>
    </div>

    <!-- Lifetime Points Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Lifetime Points</p>
                <p class="text-2xl font-bold text-gray-900">{{ lifetime_points }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <a href="{% url 'rewards_catalog' %}" class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
            <div class="p-2 bg-blue-100 rounded-lg mr-3">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                </svg>
            </div>
            <span class="font-medium">Browse Rewards</span>
        </a>
        
        <button onclick="checkIn()" class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
            <div class="p-2 bg-green-100 rounded-lg mr-3">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </div>
            <span class="font-medium">Check In</span>
        </button>
        
        <a href="{% url 'transaction_history' %}" class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
            <div class="p-2 bg-yellow-100 rounded-lg mr-3">
                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
            </div>
            <span class="font-medium">View History</span>
        </a>
        
        <button onclick="getRecommendations()" class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
            <div class="p-2 bg-purple-100 rounded-lg mr-3">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
            </div>
            <span class="font-medium">Get Suggestions</span>
        </button>
    </div>
</div>

<!-- Recent Transactions -->
<div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h2>
    <div class="space-y-3">
        {% for transaction in recent_transactions %}
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center">
                <div class="p-2 rounded-full {% if transaction.transaction_type == 'earn' %}bg-green-100 text-green-600{% else %}bg-red-100 text-red-600{% endif %}">
                    {% if transaction.transaction_type == 'earn' %}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    {% else %}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path>
                        </svg>
                    {% endif %}
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">{{ transaction.description }}</p>
                    <p class="text-xs text-gray-500">{{ transaction.timestamp|date:"M d, Y H:i" }}</p>
                </div>
            </div>
            <span class="font-semibold {% if transaction.transaction_type == 'earn' %}text-green-600{% else %}text-red-600{% endif %}">
                {% if transaction.transaction_type == 'earn' %}+{% else %}-{% endif %}{{ transaction.points }} pts
            </span>
        </div>
        {% empty %}
        <p class="text-gray-500 text-center py-4">No recent activity</p>
        {% endfor %}
    </div>
</div>

<!-- AI Recommendations -->
<div class="bg-white rounded-lg shadow p-6" id="recommendations-section" style="display: none;">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Personalized Recommendations</h2>
    <div id="recommendations-content">
        <!-- Recommendations will be loaded here -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function checkIn() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
    }

    navigator.geolocation.getCurrentPosition(async (position) => {
        try {
            const response = await fetch('/api/checkin/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    location_id: 'auto-detect' // This would need location detection logic
                })
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Check-in successful! You earned ${data.points_earned} points.`);
                location.reload();
            } else {
                alert('Check-in failed. Please try again.');
            }
        } catch (error) {
            console.error('Check-in error:', error);
            alert('Check-in failed. Please try again.');
        }
    });
}

async function getRecommendations() {
    try {
        const response = await fetch('/api/recommendations/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });

        if (response.ok) {
            const recommendations = await response.json();
            displayRecommendations(recommendations);
        }
    } catch (error) {
        console.error('Error fetching recommendations:', error);
    }
}

function displayRecommendations(recommendations) {
    const section = document.getElementById('recommendations-section');
    const content = document.getElementById('recommendations-content');
    
    if (recommendations.length === 0) {
        content.innerHTML = '<p class="text-gray-500 text-center py-4">No recommendations available</p>';
    } else {
        content.innerHTML = recommendations.map(rec => `
            <div class="border border-gray-200 rounded-lg p-4 mb-3">
                <h3 class="font-medium text-gray-900">${rec.content.title}</h3>
                <p class="text-sm text-gray-600 mt-1">${rec.content.description}</p>
                <div class="flex justify-between items-center mt-3">
                    <span class="text-sm text-blue-600">${rec.content.points_required} points required</span>
                    <button onclick="markRecommendationViewed('${rec.id}')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                        Mark as Viewed
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    section.style.display = 'block';
}

async function markRecommendationViewed(recId) {
    try {
        await fetch(`/api/recommendations/${recId}/view/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'X-CSRFToken': csrftoken
            }
        });
    } catch (error) {
        console.error('Error marking recommendation as viewed:', error);
    }
}
</script>
{% endblock %}
